/* 
 * heatmap.js OpenLayers Heatmap Class
 *
 * Copyright (c) 2011, Patrick Wied (http://www.patrick-wied.at)
 * Dual-licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and the Beerware (http://en.wikipedia.org/wiki/Beerware) license.
 * 
 * Modified on Jun,06 2011 by Antonio Santiago (http://www.acuriousanimal.com)
 * - Heatmaps as independent map layer.
 * - Points based on OpenLayers.LonLat.
 * - Data initialization in constructor.
 * - Improved 'addDataPoint' to add new lonlat based points.
 */OpenLayers.Layer.Heatmap=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,heatmap:null,mapLayer:null,tmpData:{},initialize:function(a,b,c,d,e){var f=document.createElement("div"),g;OpenLayers.Layer.prototype.initialize.apply(this,[a,e]),f.style.cssText="position:absolute;width:"+b.size.w+"px;height:"+b.size.h+"px;",this.div.appendChild(f),d.element=f,this.mapLayer=c,this.map=b,this.heatmap=h337.create(d),g=function(){this.tmpData.max&&this.updateLayer()},b.events.register("zoomend",this,g),b.events.register("moveend",this,g)},updateLayer:function(){var a=this.getPixelOffset(),b=this.heatmap.get("element");b.style.top=(a.y>0?"-"+a.y:Math.abs(a.y))+"px",b.style.left=(a.x>0?"-"+a.x:Math.abs(a.x))+"px",this.setDataSet(this.tmpData)},getPixelOffset:function(){var a=this.mapLayer.map.layerContainerOrigin,b=new OpenLayers.LonLat(a.lon,a.lat),c=this.mapLayer.getViewPortPxFromLonLat(b),d=this.mapLayer.map.center,e=new OpenLayers.LonLat(d.lon,d.lat),f=this.mapLayer.getViewPortPxFromLonLat(e);return{x:c.x-f.x,y:c.y-f.y}},setDataSet:function(a){var b={},c=a.data,d=c.length,e,f,g;b.max=a.max,b.data=[];while(d--)e=c[d],f=e.lonlat.clone().transform(this.projection,this.map.getProjectionObject()),g=this.roundPixels(this.getViewPortPxFromLonLat(f)),g&&b.data.push({x:g.x,y:g.y,count:e.count});this.tmpData=a,this.heatmap.store.setDataSet(b)},roundPixels:function(a){return a.x<0||a.y<0?!1:(a.x=a.x>>0,a.y=a.y>>0,a)},addDataPoint:function(a){var b=this.roundPixels(this.mapLayer.getViewPortPxFromLonLat(a)),c={lonlat:a},d;arguments.length==2&&(c.count=arguments[1]),this.tmpData.data.push(c),b&&(d=[b.x,b.y],arguments.length==2&&d.push(arguments[1]),this.heatmap.store.addDataPoint.apply(this.heatmap.store,d))},toggle:function(){this.heatmap.toggleDisplay()},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.Heatmap"});